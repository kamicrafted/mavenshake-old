{% extends "_layouts/base" %}
{% block body_class %}view-product{% endblock %}

{% block sitemeta %}
<title>{{ product.title }} | Mavenshake</title>
<meta name="description" content="{{ "The example templates for Craft Commerce"|t }}">
{% endblock %}

{% block main %}

{# Testing Subscriptions #}
{% set plans = craft.commerce.getPlans().getAllPlans() %}

{% if currentUser and plans|length %}
  {% for plan in plans %}
    <div class="md:flex service">
      <div class="md:w-1/4">
        <h2 class="mt-8">{{ plan.name }}</h2>
        {% set information = plan.getInformation() %}
      </div>
      <div class="md:w-3/4 md:mt-8 md:pt-4">
        {% set subscriptions = plan.getActiveUserSubscriptions(currentUser.id) %}
        {% if subscriptions|length == 0 %}
          <p>
            <strong>You have no subscriptions to this plan.</strong>
          </p>
        {% endif %}
        {% if subscriptions|length > 1 %}
          <p>
            <strong>You have multiple subscriptions to this plan.</strong>
          </p>
        {% endif %}
        {% for subscription in subscriptions %}
          {% if subscription.isCanceled %}
            Your subscription was canceled on
            {{ subscription.dateCanceled|date('Y-m-d') }}
            and will expire on
            {{ subscription.nextPaymentDate|date('Y-m-d') }}
          {% else %}
            You are subscribed and your next payment is due on
            {{ subscription.nextPaymentDate|date('Y-m-d') }}
          {% endif %}
          <br/><br/>

          <a href="{{ url('/shop/services/subscription', {subscription: subscription.id}) }}">Manage subscription</a><br/><br/>
        {% endfor %}
      </div>
    </div>
    {% if loop.last %}
      <hr/>
    {% endif %}
  {% endfor %}
  <div class="md:flex">
    <div class="md:w-1/4">
      <h2>Available plans</h2>
    </div>
    <div class="md:w-3/4 md:pt-4">
      {% for plan in plans %}
        <form method="POST">
          <input type="hidden" name="action" value="commerce/subscriptions/subscribe">
          <input type="hidden" name="planUid" value="{{ plan.uid|hash }}">
          {{ redirectInput('shop/services') }}
          {{ csrfInput() }}

          <h4>{{ plan.name }}</h4>

          <select name="trialDays" data-plan="{{ plan.id }}">
            {% for i in [0, 3, 7, 14] %}
              {% if i == 0 %}
                <option value="{{ (plan.uid~':0')|hash}}">No trial period.</option>
              {% else %}
                <option value="{{ (plan.uid~':'~i)|hash }}">Trial for
                  {{ i }}
                  days</option>
              {% endif %}
            {% endfor %}
          </select>

          {% set paymentSources = craft.commerce.getPaymentSources().getAllGatewayPaymentSourcesByUserId(plan.gateway.id, currentUser.id ?? null) %}

          {% if not paymentSources|length %}
            <div class="paymentForm">
              {{ plan.gateway.getPaymentFormHtml({})|raw }}
            </div>
          {% endif %}

          <button type="submit">{{ "Subscribe"|t }}</button>
        </form>
      {% endfor %}
    </div>
  </div>
{% endif %}


{# END Testing Subscriptions #}
        <div class="mt-8">
            <a href="{{ url('shop/products') }}">&larr; All products</a>
        </div>

        <div class="flex -mx-6 mt-8 product-details">
            <div class="w-1/2 mx-6 p-8">
                {% set rel = product.productPhoto.one() %}
                {% if rel %}
                <img src="/images/products/{{ rel.filename }}" alt="">
                {% endif %}
            </div>
            <div class="w-1/2 mx-6 p-8">
                <h1>{{ product.title }}</h1>

                <form method="POST">
                    {{ product.intro }}

                    <input type="hidden" name="action" value="commerce/cart/update-cart">
                    {{ redirectInput('shop/cart') }}
                    
                    {{ csrfInput() }}
                    <div class="field">
                        <h5>Supply amount</h5>
                        <select name="purchasableId">
                            {% for purchasable in product.variants %}
                                <option {% if purchasable.stock <= 0 and purchasable.hasUnlimitedStock == false %}disabled {% endif %}
                                        value="{{ purchasable.id }}">
                                        {# {{ purchasable.sku }} #} {{ purchasable.title }} {{ purchasable.salePrice|commerceCurrency(cart.currency) }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="field">
                        <h5>Quantity</h5>
                        {# <input type="hidden" name="qty" value="1"> #}
                        <input type="number" name="qty" value="1">
                    </div>
                    <div class="buttons">
                        <input type="submit" value="{{ "Add to cart"|t }}" class="button"/>
                    </div>

                    {{ product.description }}
                </form>
            </div>
        </div>
{% endblock %}
